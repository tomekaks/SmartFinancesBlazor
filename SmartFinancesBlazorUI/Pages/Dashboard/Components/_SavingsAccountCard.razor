@inject NavigationManager NavigationManager
@inject IDashboardService DashboardService
@inject IDialogService DialogService

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudButton Variant="Variant.Text" OnClick="NavigateToTransfers" StartIcon="@Icons.Material.Filled.Savings">
                <MudText Typo="Typo.h5">Savings</MudText>
            </MudButton>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (_settingGoal)
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success">
                    Setting Goal<MudProgressCircular Indeterminate="true" Size="Size.Small"></MudProgressCircular>
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OpenSetGoalDialog">Set goal</MudButton>
            }
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudText>Savings goal: @SavingsAccount.Goal</MudText>
        <MudText>Balance: @SavingsAccount.Balance</MudText>
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public SavingsAccountVM SavingsAccount { get; set; }

    [Parameter]
    public EventCallback OnConfirmGoal { get; set; }

    private bool _settingGoal = false;

    private async Task OpenSetGoalDialog()
    {
        _settingGoal = true;
        var title = "Set Savings Goal";

        var parameters = new DialogParameters<_SetValueDialog>
        {
            { x => x.InitialValue, SavingsAccount.Goal }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<_SetValueDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newGoal = (decimal)result.Data;
            await SetSavingsGoal(newGoal);
        }
        _settingGoal = false;
    }

    private async Task SetSavingsGoal(decimal newGoal)
    {
        await DashboardService.SetSavingsGoalAsync(newGoal);
        SavingsAccount.Goal = newGoal;

        _settingGoal = false;
        await OnConfirmGoal.InvokeAsync();
    }

    private void NavigateToTransfers()
    {
        NavigationManager.NavigateTo("/savingstransfers");
    }
}
